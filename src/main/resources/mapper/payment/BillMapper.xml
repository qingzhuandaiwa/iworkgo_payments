<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yk.iworkgo.payment.mapper.BillMapper">
    <resultMap id="BaseResultMap" type="com.yk.iworkgo.payment.entity.Bill" >
        <id column="billId" property="billId" jdbcType="BIGINT" />
        <result column="billType" property="billType" jdbcType="VARCHAR" />
        <result column="primeAmount" property="primeAmount" jdbcType="DECIMAL" />

        <result column="overDueFineTheoryAmount" property="overDueFineTheoryAmount" jdbcType="DECIMAL" />
        <result column="actualAmount" property="actualAmount" jdbcType="DECIMAL" />
        <result column="buildingName" property="buildingName" jdbcType="VARCHAR" />
        <result column="roomNumber" property="roomNumber" jdbcType="VARCHAR" />
        <result column="overDueFineStatus" property="overDueFineStatus" jdbcType="VARCHAR" />

        <result column="dueStatusName" property="dueStatusName" jdbcType="VARCHAR" />
        <result column="settleStatus" property="settleStatus" jdbcType="VARCHAR" />
        <result column="settleStatusName" property="settleStatusName" jdbcType="VARCHAR" />
        <result column="startDate" property="startDate" jdbcType="TIMESTAMP" />
        <result column="endDate" property="endDate" jdbcType="TIMESTAMP" />
        <result column="isDel" property="isDel" jdbcType="INTEGER" />
    </resultMap>

    <select id="getCurrentBillS" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        a.*
        FROM
        t_bill a
        INNER JOIN (
        SELECT
        objectId,
        MIN(expiredDay) AS expiredDay
        FROM
        t_bill
        WHERE
        objectType='CONTRACT' and expiredDay > 0 and billType LIKE '%租金%' and closedStatus='NORMAL'
        and settleStatus IN ("IN_PROCESS","PART_SETTLE")
        <if test="cond.tenantId != null and cond.tenantId != ''">
            and tenantId = #{cond.tenantId}
        </if>
        GROUP BY
        objectId
        ) b ON a.objectId = b.objectId
        AND a.expiredDay = b.expiredDay
        ORDER BY a.expiredDay asc
    </select>

    <select id="getOverdueBillS" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        *
        FROM
        t_bill
        WHERE
        objectType = 'CONTRACT'
        <![CDATA[ AND expiredDay < 0 ]]>
        AND billType LIKE '%租金%'
        AND closedStatus = 'NORMAL'
        AND settleStatus IN ("IN_PROCESS", "PART_SETTLE")
        <if test="cond.tenantId != null and cond.tenantId != ''">
            and tenantId = #{cond.tenantId}
        </if>
        ORDER BY expiredDay asc
    </select>

</mapper>
